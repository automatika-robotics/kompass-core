name: Test GPGPU Install with ACPP

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

env:
  PIP_BREAK_SYSTEM_PACKAGES: 1

jobs:
  install_gpu:
    strategy:
      matrix:
        os-arch:
          - { os: ubuntu-latest, arch: x86_64 }
          - { os: ubuntu-24.04-arm, arch: aarch64 }
          - { os: ubuntu-22.04-arm, arch: aarch64 }

    name: Build on ${{ matrix.os-arch.os }} ${{ matrix.os-arch.arch }}
    runs-on: ${{ matrix.os-arch.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Install GPGPU dependencies and kompass-core
        # We run the script from the checked-out build_dependencies folder directly
        # This prevents the script from trying to clone anything
        run: |
          sudo bash build_dependencies/install_gpu.sh --keep-source-files

      - name: Install test dependencies
        run: pip install pytest opencv-python

      - name: Run tests
        run: pytest tests
